name: Deploy AWS Lambda (Update Existing Function)

on:
  push:
    branches: [ main ]

permissions:
  contents: read

env:
  FUNCTION_NAME: GHA-Lambda     # EXACT name from your ARN
  ALIAS_NAME: prod              # alias we maintain

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}   # must be eu-north-1

      - name: Show AWS account and region
        run: |
          REGION="${{ secrets.AWS_REGION }}"
          echo "Region from secret: $REGION"
          echo "Caller identity (account should be 542834090568):"
          aws sts get-caller-identity --region "$REGION"

      - name: Install dependencies (optional)
        run: |
          if [ -f requirements.txt ]; then python -m pip install --target . -r requirements.txt; fi
          if [ -f package.json ]; then npm ci; fi

      - name: Build zip artifact
        run: |
          mkdir -p dist
          zip -r dist/function.zip .

      - name: List functions in region
        run: |
          REGION="${{ secrets.AWS_REGION }}"
          echo "Functions in $REGION:"
          aws lambda list-functions --region "$REGION" --query 'Functions[].FunctionName'

      - name: Update Lambda function code
        run: |
          REGION="${{ secrets.AWS_REGION }}"
          aws lambda update-function-code \
            --function-name "${{ env.FUNCTION_NAME }}" \
            --zip-file fileb://dist/function.zip \
            --region "$REGION"

      - name: Publish version
        id: publish
        run: |
          REGION="${{ secrets.AWS_REGION }}"
          VERSION=$(aws lambda publish-version \
            --function-name "${{ env.FUNCTION_NAME }}" \
            --query Version --output text \
            --region "$REGION")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Published version: $VERSION"

      - name: Create or Update alias
        run: |
          REGION="${{ secrets.AWS_REGION }}"
          FN="${{ env.FUNCTION_NAME }}"
          ALIAS="${{ env.ALIAS_NAME }}"
          VER="${{ steps.publish.outputs.version }}"
          if aws lambda get-alias --function-name "$FN" --name "$ALIAS" --region "$REGION" >/dev/null 2>&1; then
            echo "Updating alias $ALIAS -> version $VER"
            aws lambda update-alias --function-name "$FN" --name "$ALIAS" --function-version "$VER" --region "$REGION"
          else
            echo "Creating alias $ALIAS -> version $VER"
            aws lambda create-alias --function-name "$FN" --name "$ALIAS" --function-version "$VER" --region "$REGION"
          fi

      # Optional: smoke test to ensure alias invokes fine
      # - name: Smoke test invoke (via alias)
      #   run: |
      #     REGION="${{ secrets.AWS_REGION }}"
      #     aws lambda invoke \
      #       --function-name "${{ env.FUNCTION_NAME }}" \
      #       --qualifier "${{ env.ALIAS_NAME }}" \
      #       --payload '{}' \
      #       --region "$REGION" \
      #       response.json
      #     cat response.json
