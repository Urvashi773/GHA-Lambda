name: Deploy AWS Lambda - Production Ready

on:
  push:
    branches: [main]
    paths-ignore:
      - '**.md'
      - '.gitignore'
  pull_request:
    branches: [main]

permissions:
  contents: read
  id-token: write

env:
  FUNCTION_NAME: GHA-Lambda
  PYTHON_VERSION: '3.14'
  AWS_REGION: ${{ secrets.AWS_REGION }}

jobs:
  # ============================================================
  # JOB 1: Security & Quality Checks
  # ============================================================
  security:
    name: Security & Code Quality
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install security tools
        run: |
          pip install bandit pylint
        continue-on-error: true

      - name: Security scan with Bandit
        run: |
          echo "Scanning for security vulnerabilities..."
          bandit -r . -ll || echo "Security warnings found (non-blocking)"
        continue-on-error: true

      - name: Lint code
        run: |
          echo "Linting Python code..."
          pylint app.py --fail-under=7.0 || echo "Linting warnings (non-blocking)"
        continue-on-error: true

  # ============================================================
  # JOB 2: Build Lambda Package
  # ============================================================
  build:
    name: Build Lambda Package
    runs-on: ubuntu-latest
    needs: security
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies (if exists)
        run: |
          mkdir -p package
          if [ -f requirements.txt ]; then
            echo "Installing dependencies..."
            pip install --target ./package -r requirements.txt
            echo "Dependencies installed"
          else
            echo "No requirements.txt found - skipping dependencies"
          fi

      - name: Create Lambda deployment package
        run: |
          mkdir -p dist
          
          # Package dependencies first (if they exist)
          if [ -d "package" ] && [ "$(ls -A package)" ]; then
            echo "Packaging dependencies..."
            cd package
            zip -r ../dist/function.zip . -x '*.pyc' -x '*__pycache__*'
            cd ..
            echo "Dependencies packaged"
          fi
          
          # Add Lambda handler
          echo "Adding Lambda handler (app.py)..."
          zip -g dist/function.zip app.py
          
          # Verify package
          echo ""
          echo "Package details:"
          ls -lh dist/function.zip
          echo ""
          echo "Package contents (first 15 files):"
          unzip -l dist/function.zip | head -20
          
          echo "Lambda package created successfully"

      - name: Upload build artifact
        uses: actions/upload-artifact@v4
        with:
          name: lambda-package-${{ github.sha }}
          path: dist/function.zip
          retention-days: 30

  # ============================================================
  # JOB 3: Deploy to AWS Lambda
  # ============================================================
  deploy:
    name: Deploy to Lambda
    runs-on: ubuntu-latest
    needs: build
    steps:
      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: lambda-package-${{ github.sha }}
          path: dist

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ env.AWS_REGION }}

      - name: Verify AWS identity
        run: |
          echo "Verifying AWS credentials..."
          aws sts get-caller-identity
          echo ""
          echo "Deploying to region: ${{ env.AWS_REGION }}"

      - name: Get current version (for rollback)
        id: current-version
        run: |
          if aws lambda get-alias \
            --function-name "${{ env.FUNCTION_NAME }}" \
            --name "prod" \
            --region "${{ env.AWS_REGION }}" >/dev/null 2>&1; then
            
            CURRENT_VERSION=$(aws lambda get-alias \
              --function-name "${{ env.FUNCTION_NAME }}" \
              --name "prod" \
              --region "${{ env.AWS_REGION }}" \
              --query 'FunctionVersion' \
              --output text)
            
            echo "version=$CURRENT_VERSION" >> "$GITHUB_OUTPUT"
            echo "Current prod version: $CURRENT_VERSION"
          else
            echo "No existing prod alias found"
            echo "version=" >> "$GITHUB_OUTPUT"
          fi

      - name: Update Lambda function code
        run: |
          echo "Updating Lambda function code..."
          aws lambda update-function-code \
            --function-name "${{ env.FUNCTION_NAME }}" \
            --zip-file fileb://dist/function.zip \
            --region "${{ env.AWS_REGION }}" \
            --output json > update-output.json
          
          cat update-output.json
          echo "Function code updated"

      - name: Wait for function to be ready
        run: |
          echo "Waiting for function update to complete..."
          aws lambda wait function-updated \
            --function-name "${{ env.FUNCTION_NAME }}" \
            --region "${{ env.AWS_REGION }}"
          echo "Function is ready"

      - name: Publish new version
        id: publish
        run: |
          echo "Publishing new version..."
          VERSION=$(aws lambda publish-version \
            --function-name "${{ env.FUNCTION_NAME }}" \
            --description "GitHub Actions deployment - Commit: ${{ github.sha }}" \
            --region "${{ env.AWS_REGION }}" \
            --query 'Version' \
            --output text)
          
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Published version: $VERSION"

      - name: Smoke test - Invoke function
        id: smoke-test
        run: |
          echo "Running smoke test..."
          
          # Invoke Lambda with inline JSON (simpler approach)
          aws lambda invoke \
            --function-name "${{ env.FUNCTION_NAME }}" \
            --qualifier "${{ steps.publish.outputs.version }}" \
            --cli-binary-format raw-in-base64-out \
            --payload '{}' \
            --region "${{ env.AWS_REGION }}" \
            response.json
          
          echo ""
          echo "Lambda response:"
          cat response.json
          echo ""
          
          # Check for errors
          if grep -q "errorMessage" response.json; then
            echo "Smoke test FAILED - Function returned an error"
            cat response.json
            exit 1
          fi
          
          echo "Smoke test PASSED"

      - name: Update prod alias
        run: |
          FUNCTION_NAME="${{ env.FUNCTION_NAME }}"
          VERSION="${{ steps.publish.outputs.version }}"
          REGION="${{ env.AWS_REGION }}"
          
          if aws lambda get-alias \
            --function-name "$FUNCTION_NAME" \
            --name "prod" \
            --region "$REGION" >/dev/null 2>&1; then
            
            echo "Updating prod alias to version $VERSION"
            aws lambda update-alias \
              --function-name "$FUNCTION_NAME" \
              --name "prod" \
              --function-version "$VERSION" \
              --description "Updated by GitHub Actions - $(date -u +"%Y-%m-%d %H:%M:%S UTC")" \
              --region "$REGION"
          else
            echo "Creating prod alias for version $VERSION"
            aws lambda create-alias \
              --function-name "$FUNCTION_NAME" \
              --name "prod" \
              --function-version "$VERSION" \
              --description "Created by GitHub Actions - $(date -u +"%Y-%m-%d %H:%M:%S UTC")" \
              --region "$REGION"
          fi
          
          echo "Prod alias updated successfully"

      - name: Final smoke test on prod alias
        run: |
          echo "Testing prod alias..."
          
          aws lambda invoke \
            --function-name "${{ env.FUNCTION_NAME }}:prod" \
            --cli-binary-format raw-in-base64-out \
            --payload '{}' \
            --region "${{ env.AWS_REGION }}" \
            response-prod.json
          
          echo ""
          echo "Prod alias response:"
          cat response-prod.json
          echo ""
          
          if grep -q "errorMessage" response-prod.json; then
            echo "Prod alias test FAILED"
            exit 1
          fi
          
          echo "Prod alias working correctly"

      - name: Rollback on failure
        if: failure() && steps.current-version.outputs.version != ''
        run: |
          echo "DEPLOYMENT FAILED - Initiating rollback..."
          echo "Rolling back to version: ${{ steps.current-version.outputs.version }}"
          
          aws lambda update-alias \
            --function-name "${{ env.FUNCTION_NAME }}" \
            --name "prod" \
            --function-version "${{ steps.current-version.outputs.version }}" \
            --description "ROLLED BACK by GitHub Actions due to deployment failure" \
            --region "${{ env.AWS_REGION }}"
          
          echo "Rollback completed - prod alias restored to version ${{ steps.current-version.outputs.version }}"

      - name: Create deployment summary
        if: success()
        run: |
          cat >> $GITHUB_STEP_SUMMARY << EOF
          ## Lambda Deployment Successful
          
          | Property | Value |
          |----------|-------|
          | **Function** | \`${{ env.FUNCTION_NAME }}\` |
          | **Region** | \`${{ env.AWS_REGION }}\` |
          | **New Version** | \`${{ steps.publish.outputs.version }}\` |
          | **Previous Version** | \`${{ steps.current-version.outputs.version || 'N/A' }}\` |
          | **Alias** | \`prod\` |
          | **Commit** | \`${{ github.sha }}\` |
          | **Branch** | \`${{ github.ref_name }}\` |
          | **Deployed by** | \`${{ github.actor }}\` |
          | **Timestamp** | $(date -u +"%Y-%m-%d %H:%M:%S UTC") |
          
          ### Status
          - Security scan: Completed
          - Build: Successful
          - Smoke tests: PASSED
          - Deployment: SUCCESSFUL
          
          ### Quick Links
          - [Lambda Console](https://${{ env.AWS_REGION }}.console.aws.amazon.com/lambda/home?region=${{ env.AWS_REGION }}#/functions/${{ env.FUNCTION_NAME }})
          - [CloudWatch Logs](https://${{ env.AWS_REGION }}.console.aws.amazon.com/cloudwatch/home?region=${{ env.AWS_REGION }}#logsV2:log-groups/log-group/\$252Faws\$252Flambda\$252F${{ env.FUNCTION_NAME }})
          EOF
