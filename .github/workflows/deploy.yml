name: Deploy AWS Lambda (Update Existing Function)

on:
  push:
    branches: [ main ]

permissions:
  contents: read

env:
  FUNCTION_NAME: GHA-Lambda     # existing Lambda created in the console
  ALIAS_NAME: prod              # stable alias we maintain

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      # Auth using GitHub Secrets (same style as the Medium reference)
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}   # e.g., eu-west-1

      # Optional: install deps if you have requirements.txt or package.json
      - name: Install dependencies (optional)
        run: |
          if [ -f requirements.txt ]; then python -m pip install --target . -r requirements.txt; fi
          if [ -f package.json ]; then npm ci; fi

      - name: Build zip artifact
        run: |
          mkdir -p dist
          zip -r dist/function.zip .

      - name: Update Lambda function code
        run: |
          REGION="${{ secrets.AWS_REGION }}"
          aws lambda update-function-code \
            --function-name "${{ env.FUNCTION_NAME }}" \
            --zip-file fileb://dist/function.zip \
            --region "$REGION"

      - name: Publish version
        id: publish
        run: |
          REGION="${{ secrets.AWS_REGION }}"
          VERSION=$(aws lambda publish-version \
            --function-name "${{ env.FUNCTION_NAME }}" \
            --query Version --output text \
            --region "$REGION")
          echo "version=$VERSION" >> "$GITHUB_OUTPUT"
          echo "Published version: $VERSION"

      - name: Create or Update alias
        run: |
          REGION="${{ secrets.AWS_REGION }}"
          FN="${{ env.FUNCTION_NAME }}"
          ALIAS="${{ env.ALIAS_NAME }}"
          VER="${{ steps.publish.outputs.version }}"

          if aws lambda get-alias --function-name "$FN" --name "$ALIAS" --region "$REGION" >/dev/null 2>&1; then
            echo "Updating alias $ALIAS -> version $VER"
            aws lambda update-alias --function-name "$FN" --name "$ALIAS" --function-version "$VER" --region "$REGION"
          else
            echo "Creating alias $ALIAS -> version $VER"
            aws lambda create-alias --function-name "$FN" --name "$ALIAS" --function-version "$VER" --region "$REGION"
          fi

      # (Optional) quick smoke test to ensure the alias invokes fine
      # - name: Smoke test invoke (via alias)
      #   run: |
      #     REGION="${{ secrets.AWS_REGION }}"
      #     aws lambda invoke \
      #       --function-name "${{ env.FUNCTION_NAME }}" \
      #       --qualifier "${{ env.ALIAS_NAME }}" \
      #       --payload '{}' \
      #       --region "$REGION" \
      #       response.json
      #     cat response.json
